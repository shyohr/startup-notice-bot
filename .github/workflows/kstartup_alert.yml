name: K-Startup Daily Custom Alert

on:
  schedule:
    - cron: '0 0 * * *' # í•œêµ­ ì‹œê°„ ë§¤ì¼ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:

jobs:
  scan-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install requests beautifulsoup4

      - name: Run Scraper
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python -c "
          import requests
          from bs4 import BeautifulSoup
          import os
          import json
          import datetime
          import re

          def send_discord(text):
              webhook_url = os.environ.get('DISCORD_WEBHOOK')
              # json.dumpsë¥¼ ì‚¬ìš©í•˜ì—¬ \n ê¸€ì ë…¸ì¶œ ë¬¸ì œë¥¼ ì›ì²œ ì°¨ë‹¨í•©ë‹ˆë‹¤.
              payload = json.dumps({'content': text}, ensure_ascii=False)
              requests.post(webhook_url, data=payload.encode('utf-8'), headers={'Content-Type': 'application/json'})

          try:
              url = 'https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do'
              headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'}
              
              res = requests.get(url, headers=headers, timeout=30, verify=False)
              soup = BeautifulSoup(res.text, 'html.parser')
              
              # ì¹´ë“œí˜• UI ë° ë¦¬ìŠ¤íŠ¸í˜• UI ëª¨ë‘ ëŒ€ì‘ ê°€ëŠ¥í•œ ì„ íƒì
              posts = soup.select('div.pbancList > ul > li') or soup.select('ul > li')
              
              keywords = ['ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€', 'ì´ˆê¸°ì°½ì—…íŒ¨í‚¤ì§€', 'ì°½ì—…ë„ì•½íŒ¨í‚¤ì§€', 'ì°½ì—…íŒ¨í‚¤ì§€', 'ì²­ë…„ì°½ì—…ì‚¬ê´€í•™êµ']
              found_items = []

              for post in posts:
                  title_tag = post.find('a')
                  if not title_tag: continue
                  
                  title = title_tag.get_text(strip=True)
                  
                  # í‚¤ì›Œë“œ ë§¤ì¹­ í™•ì¸
                  if any(k in title for k in keywords):
                      # ë§ˆê°ì¼ ì¶”ì¶œ (ë‚ ì§œ í˜•ì‹ 0000-00-00 ë˜ëŠ” 00.00.00 íƒìƒ‰)
                      date_text = 'ìƒì„¸ê³µê³  ì°¸ì¡°'
                      full_text = post.get_text(strip=True)
                      date_match = re.search(r'(\d{4}-\d{2}-\d{2})|(\d{2}\.\d{2}\.\d{2})', full_text)
                      if date_match:
                          date_text = date_match.group(0)
                      
                      # ê³ ìœ  ë²ˆí˜¸ë¥¼ í†µí•œ ìƒì„¸ í˜ì´ì§€ ë§í¬ ìƒì„±
                      sn_match = re.search(r'pbancSn=(\d+)', title_tag.get('href', '') + title_tag.get('onclick', ''))
                      if sn_match:
                          link = f'https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do?schMnuId=S010101&pbancSn={sn_match.group(1)}'
                      else:
                          link = url
                      
                      found_items.append({
                          'title': title,
                          'date': date_text,
                          'link': link
                      })

              today = datetime.datetime.now().strftime('%Y-%m-%d')
              
              if not found_items:
                  # ê³µê³ ê°€ ì—†ì„ ê²½ìš° ìƒì¡´ ì‹ ê³ ìš© ë©”ì‹œì§€
                  message = f'ğŸ“… **[{today} ë§ì¶¤í˜• ì°½ì—… ì§€ì› ê³µê³ ]**\n\ní˜„ì¬ ëª¨ì§‘ ì¤‘ì¸ ì£¼ìš” í‚¤ì›Œë“œ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.'
              else:
                  # ìš”ì²­í•˜ì‹  ì˜ˆì‹œ í¬ë§· ê·¸ëŒ€ë¡œ êµ¬ì„±
                  message = f'**[{today} ë§ì¶¤í˜• ì°½ì—… ì§€ì› ê³µê³ ]**\n\n'
                  for item in found_items:
                      message += f'ğŸ“Œ {item[\"title\"]}\n'
                      message += f'ë§ˆê°ì¼: {item[\"date\"]}\n'
                      message += f'ëª¨ì§‘ê³µê³ : {item[\"link\"]}\n\n'

              send_discord(message)

          except Exception as e:
              send_discord(f'âš ï¸ ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬ ë°œìƒ: {str(e)}')
          "
