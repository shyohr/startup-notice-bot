name: K-Startup Fix Precision

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  scan-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install requests beautifulsoup4

      - name: Run Scraper
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python -c "
          import requests
          from bs4 import BeautifulSoup
          import os
          import json
          import datetime
          import re

          def send_discord(text):
              webhook_url = os.environ.get('DISCORD_WEBHOOK')
              payload = json.dumps({'content': text}, ensure_ascii=False)
              requests.post(webhook_url, data=payload.encode('utf-8'), headers={'Content-Type': 'application/json'})

          try:
              url = 'https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do'
              headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'}
              
              res = requests.get(url, headers=headers, timeout=30, verify=False)
              soup = BeautifulSoup(res.text, 'html.parser')
              
              # 1. ì‚¬ì´íŠ¸ì˜ ì¹´ë“œí˜• ë¦¬ìŠ¤íŠ¸ ë°•ìŠ¤ ì¶”ì¶œ
              # ìŠ¤í¬ë¦°ìƒ· ê¸°ì¤€ li íƒœê·¸ ë‚´ì˜ ì •ë³´ë¥¼ ëª¨ë‘ í›‘ìŠµë‹ˆë‹¤.
              posts = soup.select('ul > li')
              
              keywords = ['ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€', 'ì´ˆê¸°ì°½ì—…íŒ¨í‚¤ì§€', 'ì°½ì—…ë„ì•½íŒ¨í‚¤ì§€', 'ì°½ì—…íŒ¨í‚¤ì§€', 'ì²­ë…„ì°½ì—…ì‚¬ê´€í•™êµ']
              found_items = []

              for post in posts:
                  # ì œëª©ì´ ë“¤ì–´ìˆëŠ” íƒœê·¸ë¥¼ ë” ë„“ê²Œ íƒìƒ‰
                  title_tag = post.select_one('h4, strong, .title, a')
                  if not title_tag: continue
                  
                  raw_title = title_tag.get_text(strip=True)
                  # ë¶ˆí•„ìš”í•œ í…ìŠ¤íŠ¸('N', 'ìƒˆë¡œìš´ê²Œì‹œê¸€', 'ìƒˆì°½ì—´ê¸°') ì œê±°
                  clean_title = re.sub(r'(ìƒˆë¡œìš´ê²Œì‹œê¸€|ìƒˆì°½ì—´ê¸°|N$|NEW$|ì‚¬ì—…í™”|í–‰ì‚¬Â·ë„¤íŠ¸ì›Œí¬)', '', raw_title).strip()
                  
                  if any(k in clean_title for k in keywords):
                      # 2. ë§ˆê°ì¼ì ì •ë°€ ì¶”ì¶œ (ìŠ¤í¬ë¦°ìƒ·ì— ë³´ì´ëŠ” 'ë§ˆê°ì¼ì 2026-01-27' í…ìŠ¤íŠ¸ ì¡°ì¤€)
                      full_text = post.get_text(' ', strip=True)
                      # 'ë§ˆê°ì¼ì' ë‹¨ì–´ ë’¤ì˜ YYYY-MM-DD íŒ¨í„´ë§Œ ì •í™•íˆ ì¶”ì¶œ
                      date_match = re.search(r'ë§ˆê°ì¼ì\s*(\d{4}-\d{2}-\d{2})', full_text)
                      
                      if date_match:
                          date_val = date_match.group(1)
                      else:
                          # ë‚ ì§œ í˜•ì‹ë§Œì´ë¼ë„ ê²€ìƒ‰
                          alt_match = re.search(r'(\d{4}-\d{2}-\d{2})', full_text)
                          date_val = alt_match.group(0) if alt_match else 'ìƒì„¸ì°¸ì¡°'
                      
                      found_items.append({'title': clean_title, 'date': date_val})

              # 3. ì¤‘ë³µ ì œê±° ë° ë©”ì‹œì§€ êµ¬ì„±
              seen = set()
              unique_items = []
              for item in found_items:
                  if item['title'] not in seen:
                      unique_items.append(item)
                      seen.add(item['title'])

              today = datetime.date.today().strftime('%Y-%m-%d')
              
              if not unique_items:
                  # ì°¾ì§€ ëª»í–ˆì„ ê²½ìš°ì—ë„ ë¡œê·¸ë¥¼ ë‚¨ê¸°ê¸° ìœ„í•´ ì „ì†¡
                  message = f'**[{today} ë§ì¶¤í˜• ì°½ì—… ì§€ì› ê³µê³ ]**\n\ní˜„ì¬ ì¼ì¹˜í•˜ëŠ” í‚¤ì›Œë“œì˜ ëª¨ì§‘ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.'
              else:
                  message = f'**[{today} ë§ì¶¤í˜• ì°½ì—… ì§€ì› ê³µê³ ]**\n\n'
                  for item in unique_items:
                      message += f'ğŸ“Œ {item[\"title\"]}\n'
                      message += f'ë§ˆê°ì¼ì {item[\"date\"]}\n\n'
                  
                  message += f'ëª¨ì§‘ê³µê³ : {url}'

              send_discord(message)

          except Exception as e:
              send_discord(f'âš ï¸ ì—ëŸ¬ë°œìƒ: {str(e)}')
          "
