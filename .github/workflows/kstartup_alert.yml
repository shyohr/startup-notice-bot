name: K-Startup Python Alert

on:
  schedule:
    - cron: '0 0 * * *' # í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:

jobs:
  scan-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install requests beautifulsoup4

      - name: Run Scraper & Send Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python -c "
          import requests
          from bs4 import BeautifulSoup
          import os
          import json
          import datetime
          import re

          # 1. ì„¤ì • ë° í—¤ë” (ë¸Œë¼ìš°ì € ìœ„ì¥)
          url = 'https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do'
          webhook_url = os.environ.get('DISCORD_WEBHOOK')
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8',
              'Accept-Language': 'ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7'
          }
          
          # 2. í‚¤ì›Œë“œ ì„¤ì • (ì •ê·œì‹ìœ¼ë¡œ ìœ ì—°í•˜ê²Œ ë§¤ì¹­)
          keywords = ['ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€', 'ì´ˆê¸°ì°½ì—…íŒ¨í‚¤ì§€', 'ì°½ì—…ë„ì•½íŒ¨í‚¤ì§€', 'ì°½ì—…íŒ¨í‚¤ì§€', 'ì²­ë…„ì°½ì—…ì‚¬ê´€í•™êµ']
          
          try:
              response = requests.get(url, headers=headers, verify=False, timeout=15)
              response.encoding = 'utf-8' # í•œê¸€ ê¹¨ì§ ë°©ì§€
              soup = BeautifulSoup(response.text, 'html.parser')
              
              # 3. ê³µê³  ë¦¬ìŠ¤íŠ¸ íŒŒì‹±
              # K-Startupì˜ ì¼ë°˜ì ì¸ ë¦¬ìŠ¤íŠ¸ êµ¬ì¡° (.item í´ë˜ìŠ¤ ë˜ëŠ” ul > li êµ¬ì¡° íƒìƒ‰)
              items = soup.select('ul > li') 
              
              found_list = []
              
              for item in items:
                  text_content = item.get_text()
                  
                  # í‚¤ì›Œë“œê°€ í¬í•¨ëœ í•­ëª©ì¸ì§€ í™•ì¸
                  if any(k in text_content for k in keywords):
                      # ì œëª© ì¶”ì¶œ (title ì†ì„± í˜¹ì€ í…ìŠ¤íŠ¸)
                      title_tag = item.find('a')
                      if not title_tag: continue
                      
                      # ì œëª© ì •ì œ
                      title = title_tag.get_text(strip=True)
                      # í˜¹ì‹œ title ì†ì„±ì— ë” ì •í™•í•œ ì •ë³´ê°€ ìˆë‹¤ë©´ ì‚¬ìš©
                      if title_tag.get('title'):
                          title = title_tag['title']

                      # ë§ˆê°ì¼ ì¶”ì¶œ (ë³´í†µ span íƒœê·¸ ë“±ì— ~ '25.01.01 í˜•íƒœ)
                      date_text = 'ë‚ ì§œ ì •ë³´ ì—†ìŒ'
                      date_match = re.search(r'~\s*\'?(\d{2}\.\d{2}\.\d{2})', text_content)
                      if date_match:
                          date_text = date_match.group(1) # 25.01.01 í˜•íƒœë¡œ ì¶”ì¶œ
                      
                      # ë§í¬ ì¶”ì¶œ (pbancSn íŒŒë¼ë¯¸í„° ì°¾ê¸°)
                      link = url
                      href = title_tag.get('href', '')
                      sn_match = re.search(r'pbancSn=(\d+)', href)
                      if sn_match:
                          sn = sn_match.group(1)
                          link = f'https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do?schMnuId=S010101&pbancSn={sn}'
                      elif 'javascript' in href:
                           # ìë°”ìŠ¤í¬ë¦½íŠ¸ ë§í¬ì¼ ê²½ìš° onclick ì†ì„±ì—ì„œ ì¶”ì¶œ ì‹œë„
                           onclick = title_tag.get('onclick', '')
                           sn_match_js = re.search(r'(\d{4,})', onclick) # 4ìë¦¬ ì´ìƒ ìˆ«ì
                           if sn_match_js:
                               link = f'https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do?schMnuId=S010101&pbancSn={sn_match_js.group(1)}'

                      # ì¤‘ë³µ ë°©ì§€ ë° ê²°ê³¼ ì €ì¥
                      found_list.append({
                          'title': title,
                          'date': date_text,
                          'link': link
                      })

              # 4. ë””ìŠ¤ì½”ë“œ ë©”ì‹œì§€ ìƒì„±
              today = datetime.datetime.now().strftime('%Y-%m-%d')
              
              if not found_list:
                  content = f'ğŸ“… **{today} ì•Œë¦¼**\n\ní˜„ì¬ ëª¨ì§‘ ì¤‘ì¸ ê´€ë ¨ í•µì‹¬ íŒ¨í‚¤ì§€ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.\n(í˜ì´ì§€ íŒŒì‹± ì„±ê³µí–ˆìœ¼ë‚˜ í‚¤ì›Œë“œ ë§¤ì¹­ ì—†ìŒ)'
              else:
                  content = f'ğŸš€ **{today} ë§ì¶¤í˜• ì°½ì—… ì§€ì› ê³µê³ **\n\n'
                  for item in found_list:
                      content += f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n'
                      content += f'### ğŸ“Œ {item[\"title\"]}\n'
                      content += f'- ğŸ“… **ë§ˆê°ì¼**: `{item[\"date\"]}`\n'
                      content += f'- ğŸ”— [ìƒì„¸ê³µê³  ë°”ë¡œê°€ê¸°]({item[\"link\"]})\n\n'

              # 5. ì „ì†¡
              payload = {'content': content}
              requests.post(webhook_url, json=payload)
              print('Discord notification sent successfully.')

          except Exception as e:
              # ì—ëŸ¬ ë°œìƒ ì‹œ ë””ìŠ¤ì½”ë“œë¡œ ì—ëŸ¬ ë¡œê·¸ ì „ì†¡ (ë””ë²„ê¹…ìš©)
              err_msg = f'âš ï¸ **ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬ ë°œìƒ**\n\n{str(e)}'
              requests.post(webhook_url, json={'content': err_msg})
              print(f'Error: {e}')
          "
