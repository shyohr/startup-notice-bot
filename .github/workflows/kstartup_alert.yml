name: K-Startup Final Fix

on:
  schedule:
    - cron: '0 0 * * *' # ë§¤ì¼ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install requests beautifulsoup4

      - name: Scrape and Notify
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python -c "
          import requests
          from bs4 import BeautifulSoup
          import os
          import json
          import datetime

          def send_discord(text):
              webhook_url = os.environ.get('DISCORD_WEBHOOK')
              # JSON ì „ì†¡ ì‹œ ì¤„ë°”ê¿ˆ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ json.dumps ì‚¬ìš©
              payload = json.dumps({'content': text}, ensure_ascii=False)
              headers = {'Content-Type': 'application/json'}
              requests.post(webhook_url, data=payload.encode('utf-8'))

          try:
              url = 'https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do'
              headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'}
              
              # 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì„¸ì…˜ ìœ ì§€ ë° íƒ€ì„ì•„ì›ƒ ë³´ê°•)
              res = requests.get(url, headers=headers, timeout=30)
              soup = BeautifulSoup(res.text, 'html.parser')
              
              # 2. ì¹´ë“œí˜• UI (.announcement_list ë˜ëŠ” li.item) ì¡°ì¤€
              # ì¹´ë“œ í•œ ì¥ í•œ ì¥ì„ ì˜ë¯¸í•˜ëŠ” íƒœê·¸ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
              posts = soup.find_all('li')
              
              keywords = ['ì˜ˆë¹„ì°½ì—…', 'ì´ˆê¸°ì°½ì—…', 'ì°½ì—…ë„ì•½', 'íŒ¨í‚¤ì§€', 'ì²­ë…„ì°½ì—…ì‚¬ê´€í•™êµ']
              found = []

              for post in posts:
                  title_tag = post.find('h4') or post.find('strong') or post.find('p', class_='title')
                  if not title_tag:
                      # a íƒœê·¸ ì•ˆì— ì œëª©ì´ ìˆëŠ” ê²½ìš°
                      title_tag = post.find('a', title=True)
                  
                  if title_tag:
                      title = title_tag.get_text(strip=True)
                      if any(k in title for k in keywords):
                          # ë§ˆê°ì¼ ì¶”ì¶œ
                          date_text = post.find('span', class_='date') or post.find('li', class_='date')
                          d_day = date_text.get_text(strip=True) if date_text else 'ìƒì„¸í™•ì¸'
                          
                          # ë§í¬ ì¶”ì¶œ
                          link_tag = post.find('a')
                          href = link_tag.get('href', '#') if link_tag else '#'
                          # ìƒì„¸ë²ˆí˜¸ ì¶”ì¶œ ë¡œì§
                          import re
                          sn_match = re.search(r'pbancSn=(\d+)', href)
                          if sn_match:
                              final_url = f'https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do?schMnuId=S010101&pbancSn={sn_match.group(1)}'
                          else:
                              final_url = url
                          
                          found.append(f'ğŸ“Œ **{title}**\nğŸ“… ë§ˆê°: `{d_day}`\nğŸ”— [ë°”ë¡œê°€ê¸°]({final_url})')

              # 3. ë©”ì‹œì§€ ì¡°ë¦½
              today = datetime.datetime.now().strftime('%Y-%m-%d')
              if not found:
                  msg = f'ğŸ“… **{today} ì•Œë¦¼**\ní˜„ì¬ ì¡°ê±´ì— ë§ëŠ” ëª¨ì§‘ ì¤‘ì¸ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.'
              else:
                  # ì‹¤ì œ ì¤„ë°”ê¿ˆì„ ë¬¸ìë¡œ ë„£ì§€ ì•Šê³  ë¦¬ìŠ¤íŠ¸ë¡œ ê´€ë¦¬í•˜ì—¬ í•©ì¹¨
                  msg = f'ğŸš€ **{today} ë§ì¶¤í˜• ì°½ì—… ê³µê³ **\n' + '\n'.join(found)

              send_discord(msg)

          except Exception as e:
              send_discord(f'âš ï¸ ì˜¤ë¥˜ ë°œìƒ: {str(e)}')
          "
