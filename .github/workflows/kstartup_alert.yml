name: K-Startup Precision Alert

on:
  schedule:
    - cron: '0 0 * * *' # í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:

jobs:
  scan-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install requests beautifulsoup4

      - name: Run Scraper & Send Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python -c "
          import requests
          from bs4 import BeautifulSoup
          import os
          import json
          import datetime
          import re

          # 1. ì„¤ì •
          url = 'https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do'
          webhook_url = os.environ.get('DISCORD_WEBHOOK')
          
          # 2. ë¸Œë¼ìš°ì € ìœ„ì¥ í—¤ë” (ì°¨ë‹¨ ë°©ì§€)
          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
          }
          
          # 3. íƒ€ê²Ÿ í‚¤ì›Œë“œ
          target_keywords = ['ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€', 'ì´ˆê¸°ì°½ì—…íŒ¨í‚¤ì§€', 'ì°½ì—…ë„ì•½íŒ¨í‚¤ì§€', 'ì°½ì—…íŒ¨í‚¤ì§€', 'ì²­ë…„ì°½ì—…ì‚¬ê´€í•™êµ']

          def send_discord(content):
              if not webhook_url: return
              payload = {'content': content}
              requests.post(webhook_url, json=payload)

          try:
              response = requests.get(url, headers=headers, verify=False, timeout=20)
              soup = BeautifulSoup(response.text, 'html.parser')
              
              # 4. ì •ë°€ íŒŒì‹±: ì‹¤ì œ ê³µê³  ë¦¬ìŠ¤íŠ¸(ul > li) ë‚´ë¶€ë§Œ íƒìƒ‰
              # K-startup êµ¬ì¡°ìƒ li íƒœê·¸ ì•ˆì— ì œëª©(a)ê³¼ ë‚ ì§œ(span)ê°€ ê°™ì´ ìˆìŒ
              items = soup.find_all('li')
              
              results = []
              
              for item in items:
                  # í•´ë‹¹ li ì•ˆì— ë§í¬(a)ê°€ ì—†ìœ¼ë©´ ê³µê³  ì•„ë‹˜ -> íŒ¨ìŠ¤
                  link_tag = item.find('a')
                  if not link_tag: continue
                  
                  title = link_tag.get_text(strip=True)
                  full_text = item.get_text(strip=True) # li ì „ì²´ í…ìŠ¤íŠ¸
                  
                  # í‚¤ì›Œë“œ ë§¤ì¹­ (ì œëª©ì— í‚¤ì›Œë“œê°€ ìˆì–´ì•¼ í•¨)
                  if any(k in title for k in target_keywords):
                      
                      # ë‚ ì§œ ì¶”ì¶œ (íŒ¨í„´: ~ 2025.xx.xx ë˜ëŠ” ~ '25.xx.xx)
                      # í…ìŠ¤íŠ¸ ì „ì²´ì—ì„œ ë‚ ì§œ íŒ¨í„´ ê²€ìƒ‰
                      date_match = re.search(r'~\s*(\'|20)?(\d{2}\.\d{2}\.\d{2})', full_text)
                      
                      if date_match:
                          dday = date_match.group(0).replace('~', '').strip() # ~ ì œê±°
                      else:
                          # ë‚ ì§œê°€ ì—†ìœ¼ë©´ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì´ ì•„ë‹ í™•ë¥  ë†’ìœ¼ë¯€ë¡œ ìŠ¤í‚µí•˜ê±°ë‚˜ 'ë³„ë„í™•ì¸' ì²˜ë¦¬
                          continue 

                      # ë§í¬ ì¶”ì¶œ (pbancSn íŒŒì‹±)
                      href = link_tag.get('href', '')
                      onclick = link_tag.get('onclick', '')
                      sn = ''
                      
                      # href ë˜ëŠ” onclickì—ì„œ ìˆ«ì(sn) ì¶”ì¶œ
                      sn_match = re.search(r'pbancSn=(\d+)', href)
                      if not sn_match:
                          sn_match = re.search(r'(\d{4,})', onclick)
                      
                      if sn_match:
                          sn = sn_match.group(1)
                          link = f'https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do?schMnuId=S010101&pbancSn={sn}'
                          
                          results.append({
                              'title': title,
                              'date': dday,
                              'link': link
                          })

              # 5. ë©”ì‹œì§€ ì „ì†¡ ë¡œì§
              today = datetime.datetime.now().strftime('%Y-%m-%d')
              
              if not results:
                  # ê³µê³ ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ë©”ì‹œì§€ ì•ˆ ë³´ë‚´ê±°ë‚˜, í™•ì¸ìš© ë©”ì‹œì§€ ì „ì†¡
                  pass 
              else:
                  msg = f'ğŸš€ **{today} ë§ì¶¤í˜• ì°½ì—… ê³µê³  ì•Œë¦¼**\n'
                  msg += f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n'
                  
                  for res in results:
                      msg += f'### ğŸ“Œ {res[\"title\"]}\n'
                      msg += f'- ğŸ“… **ë§ˆê°ì¼**: `{res[\"date\"]}`\n'
                      msg += f'- ğŸ”— [ìƒì„¸ê³µê³  ë°”ë¡œê°€ê¸°]({res[\"link\"]})\n\n'
                  
                  send_discord(msg)

          except Exception as e:
              # ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œê·¸ ì¶œë ¥ (ë””ìŠ¤ì½”ë“œ ì „ì†¡ X)
              print(f'Error occurred: {e}')
          "
