name: K-Startup Status Check

on:
  schedule:
    - cron: '0 0 * * *' # í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:

jobs:
  check-and-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install requests beautifulsoup4 urllib3

      - name: Run Scraper
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python -c "
          import requests
          from bs4 import BeautifulSoup
          import os
          import json
          import datetime
          import re
          import urllib3

          # SSL ê²½ê³  ë¬´ì‹œ ì„¤ì • (ì •ë¶€ ì‚¬ì´íŠ¸ ì ‘ì† ì‹œ í•„ìˆ˜)
          urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

          # 1. ì„¤ì •
          url = 'https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do'
          webhook_url = os.environ.get('DISCORD_WEBHOOK')
          
          if not webhook_url:
              print('Error: Webhook URL is missing')
              exit(1)

          headers = {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
          }
          
          keywords = ['ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€', 'ì´ˆê¸°ì°½ì—…íŒ¨í‚¤ì§€', 'ì°½ì—…ë„ì•½íŒ¨í‚¤ì§€', 'ì°½ì—…íŒ¨í‚¤ì§€', 'ì²­ë…„ì°½ì—…ì‚¬ê´€í•™êµ']

          def send_discord(content):
              payload = {'content': content}
              try:
                  res = requests.post(webhook_url, json=payload)
                  print(f'Discord Response: {res.status_code}')
              except Exception as e:
                  print(f'Discord Send Error: {e}')

          try:
              print('Connecting to K-Startup...')
              response = requests.get(url, headers=headers, verify=False, timeout=30)
              soup = BeautifulSoup(response.text, 'html.parser')
              
              # PCë²„ì „ ë¦¬ìŠ¤íŠ¸ êµ¬ì¡° (.pbancList > ul > li)
              items = soup.select('div.pbancList > ul > li')
              # ëª¨ë°”ì¼/ë°˜ì‘í˜• êµ¬ì¡° ëŒ€ë¹„ (.list_type_common > li)
              if not items:
                  items = soup.select('ul > li')
              
              results = []
              print(f'Found {len(items)} items. Scanning for keywords...')
              
              for item in items:
                  full_text = item.get_text(strip=True)
                  link_tag = item.find('a')
                  
                  if not link_tag: continue
                  
                  title = link_tag.get_text(strip=True)
                  # ì œëª©ì´ë‚˜ ë‚´ìš©ì— í‚¤ì›Œë“œê°€ ìˆëŠ”ì§€ í™•ì¸
                  if any(k in title for k in keywords):
                      # ë‚ ì§œ ì¶”ì¶œ (~ 2025.xx.xx íŒ¨í„´)
                      dday = 'ë§ˆê°ì¼ í™•ì¸ í•„ìš”'
                      date_match = re.search(r'~\s*(\'|20)?(\d{2}\.\d{2}\.\d{2})', full_text)
                      if date_match:
                          dday = date_match.group(0).replace('~', '').strip()
                      
                      # ë§í¬ ë° ê³ ìœ ë²ˆí˜¸(sn) ì¶”ì¶œ
                      href = link_tag.get('href', '')
                      onclick = link_tag.get('onclick', '')
                      sn = ''
                      
                      sn_match = re.search(r'pbancSn=(\d+)', href)
                      if not sn_match:
                          sn_match = re.search(r'(\d{4,})', onclick)
                      
                      if sn_match:
                          sn = sn_match.group(1)
                          link = f'https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do?schMnuId=S010101&pbancSn={sn}'
                          
                          results.append({'title': title, 'date': dday, 'link': link})

              # ê²°ê³¼ ì „ì†¡ ë¡œì§
              today = datetime.datetime.now().strftime('%Y-%m-%d')
              
              if not results:
                  # ê³µê³ ê°€ ì—†ì–´ë„ ë¬´ì¡°ê±´ ë©”ì‹œì§€ ì „ì†¡ (ìƒì¡´ ì‹ ê³ )
                  msg = f'ğŸ“… **{today} K-Startup ìƒíƒœ ë³´ê³ **\n\ní˜„ì¬ ì§€ì •í•˜ì‹  í‚¤ì›Œë“œ({", ".join(keywords)})ì— í•´ë‹¹í•˜ëŠ” ëª¨ì§‘ ì¤‘ì¸ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.\n(ì‹œìŠ¤í…œì€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤)'
                  print('No matching announcements found. Sending status report.')
                  send_discord(msg)
              else:
                  msg = f'ğŸš€ **{today} ë§ì¶¤í˜• ì°½ì—… ê³µê³  ë°œê²¬!**\n'
                  msg += f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n'
                  for res in results:
                      msg += f'### ğŸ“Œ {res[\"title\"]}\n'
                      msg += f'- ğŸ“… **ë§ˆê°ì¼**: `{res[\"date\"]}`\n'
                      msg += f'- ğŸ”— [ìƒì„¸ê³µê³  ë°”ë¡œê°€ê¸°]({res[\"link\"]})\n\n'
                  print(f'Found {len(results)} announcements. Sending alert.')
                  send_discord(msg)

          except Exception as e:
              err_msg = f'âš ï¸ **ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬ ë°œìƒ**\n\n{str(e)}'
              print(f'Error: {e}')
              send_discord(err_msg)
          "
