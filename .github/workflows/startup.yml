name: K-Startup Precise Alert

on:
  schedule:
    - cron: '0 0 * * *' # í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:

jobs:
  scan-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Scan K-Startup
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # 1. ë°ì´í„° ìˆ˜ì§‘ (ì°¨ë‹¨ ë°©ì§€ë¥¼ ìœ„í•´ ë¸Œë¼ìš°ì €ì²˜ëŸ¼ ìœ„ì¥)
          LIST_URL="https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do"
          PAGE_DATA=$(curl -s -k -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36" "$LIST_URL")

          # 2. í‚¤ì›Œë“œ í•„í„°ë§ ë° ë°ì´í„° ì¶”ì¶œ (ì œëª©, ë§ˆê°ì¼, ìƒì„¸ë²ˆí˜¸ ì¶”ì¶œ)
          # K-Startupì€ pbancSnì´ë¼ëŠ” ê³ ìœ ë²ˆí˜¸ë¡œ ìƒì„¸í˜ì´ì§€ ë§í¬ë¥¼ ë§Œë“­ë‹ˆë‹¤.
          KEYWORDS="ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€|ì´ˆê¸°ì°½ì—…íŒ¨í‚¤ì§€|ì°½ì—…ë„ì•½íŒ¨í‚¤ì§€|ì°½ì—…íŒ¨í‚¤ì§€|ì²­ë…„ì°½ì—…ì‚¬ê´€í•™êµ"
          
          # ì œëª©, ë§ˆê°ì¼, ìƒì„¸ë²ˆí˜¸ë¥¼ íƒ­(\t)ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ í•œ ì¤„ì”© ì •ë¦¬
          RAW_LIST=$(echo "$PAGE_DATA" | grep -zPo '(?s)<li class="item">.*?</li>' | tr -d '\n' | sed 's/<\/li>/\n/g' | \
          grep -E "$KEYWORDS" | \
          perl -lne 'print "$1\t$2\t$3" if /title="([^"]*)".*?<span>~ ([^<]*)<\/span>.*?pbancSn=(\d+)/')

          # 3. ë©”ì‹œì§€ ìƒì„±
          FINAL_MSG=""
          while IFS=$'\t' read -r title dday sn; do
            if [[ ! -z "$title" ]]; then
              # ê°œë³„ ê³µê³  ìƒì„¸ í˜ì´ì§€ ë§í¬ ìƒì„±
              DETAIL_URL="https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do?schMnuId=S010101&pbancSn=$sn"
              
              ITEM="### ğŸ“Œ $title\n- ğŸ“… **ë§ˆê°ì¼**: \`$dday\`\n- ğŸ”— [ìƒì„¸ê³µê³  ë°”ë¡œê°€ê¸°]($DETAIL_URL)\n"
              FINAL_MSG="${FINAL_MSG}${ITEM}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            fi
          done <<< "$RAW_LIST"

          # 4. ìµœì¢… ê²°ê³¼ ì¡°ë¦½
          DATE=$(date +'%Y-%m-%d')
          if [ -z "$FINAL_MSG" ]; then
            MESSAGE="ğŸ“… **$DATE ì•Œë¦¼**\nìš”ì²­í•˜ì‹  í‚¤ì›Œë“œ(`$KEYWORDS`)ì— í•´ë‹¹í•˜ëŠ” ê³µê³ ê°€ í˜„ì¬ ì—†ìŠµë‹ˆë‹¤."
          else
            HEADER="ğŸš€ **$DATE ë§ì¶¤í˜• ì°½ì—… ì§€ì› ê³µê³ **\n\n"
            MESSAGE="${HEADER}${FINAL_MSG}"
          fi

          # 5. ë””ìŠ¤ì½”ë“œ ì „ì†¡ (jqë¥¼ í™œìš©í•˜ì—¬ \n ê¸€ì ì˜¤ë¥˜ ì™„ë²½ ì°¨ë‹¨)
          jq -n --arg msg "$MESSAGE" '{content: $msg}' | \
          curl -X POST "$DISCORD_WEBHOOK" \
               -H "Content-Type: application/json" \
               -d @-
