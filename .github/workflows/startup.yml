name: K-Startup Daily Custom Alert

on:
  schedule:
    - cron: '0 0 * * *' # í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:

jobs:
  scan-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Scan K-Startup
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í—¤ë” ë³´ê°•)
          URL="https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do"
          PAGE_DATA=$(curl -s -k -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36" "$URL")

          # 2. í‚¤ì›Œë“œ í•„í„°ë§ ë° ë°ì´í„° ì¶”ì¶œ
          # ì œëª©ê³¼ ë‚ ì§œë¥¼ ì¶”ì¶œí•˜ì—¬ ì„ì‹œ íŒŒì¼ì— ì €ì¥
          KEYWORDS="ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€|ì´ˆê¸°ì°½ì—…íŒ¨í‚¤ì§€|ì°½ì—…ë„ì•½íŒ¨í‚¤ì§€|ì°½ì—…íŒ¨í‚¤ì§€|ì²­ë…„ì°½ì—…ì‚¬ê´€í•™êµ"
          
          # ê³µê³  ì œëª©ê³¼ ë§ˆê°ì¼ì„ í•œ ìŒìœ¼ë¡œ ì¶”ì¶œ
          RAW_DATA=$(echo "$PAGE_DATA" | grep -oP "title=\"[^\"]*($KEYWORDS)[^\"]*\"|<span>~ '[0-9]{2}\.[0-9]{2}\.[0-9]{2}\." | sed "s/title=\"//;s/\"//;s/<span>//")

          # 3. ë©”ì‹œì§€ ë¹Œë“œ
          FINAL_LIST=""
          while read -r title; do
            read -r dday
            if [[ ! -z "$title" && ! -z "$dday" ]]; then
              # í•œ ê³µê³ ë‹¹ ê¹”ë”í•˜ê²Œ ë°•ìŠ¤ í˜•íƒœë¡œ êµ¬ì„±
              FINAL_LIST="${FINAL_LIST}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
              FINAL_LIST="${FINAL_LIST}ğŸ“Œ **$title**\n"
              FINAL_LIST="${FINAL_LIST}ğŸ“… ë§ˆê°ì¼ : \`$dday\`\n"
              FINAL_LIST="${FINAL_LIST}ğŸ”— [ê³µê³  ìƒì„¸ë³´ê¸°]($URL)\n\n"
            fi
          done <<< "$RAW_DATA"

          # 4. ìµœì¢… ë©”ì‹œì§€ êµ¬ì„± (ë¶ˆí•„ìš”í•œ ê³µë°± ì œê±°)
          DATE=$(date +'%Y-%m-%d')
          if [ -z "$FINAL_LIST" ]; then
            CONTENT="ğŸ“… **$DATE ì•Œë¦¼**\ní˜„ì¬ ëª¨ì§‘ ì¤‘ì¸ í•µì‹¬ íŒ¨í‚¤ì§€ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤."
          else
            CONTENT="ğŸš€ **$DATE ë§ì¶¤í˜• ì°½ì—… ì§€ì› ê³µê³ **\n\n$FINAL_LIST"
          fi

          # 5. ì „ì†¡ (jqë¥¼ ì‚¬ìš©í•˜ì—¬ JSON ì´ìŠ¤ì¼€ì´í”„ ì™„ë²½ ì²˜ë¦¬)
          # ê³µë°±ê³¼ ì¤„ë°”ê¿ˆ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ -Rs ì˜µì…˜ ì‚¬ìš©
          echo "$CONTENT" | jq -Rs '{content: .}' | \
          curl -X POST "$DISCORD_WEBHOOK" \
               -H "Content-Type: application/json" \
               -d @-
