name: K-Startup Daily Ultimate Alert

on:
  schedule:
    - cron: '0 0 * * *' # í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:

jobs:
  scan-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Scan K-Startup
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # 1. ë°ì´í„° ìˆ˜ì§‘ (ìµœì‹  ë¸Œë¼ìš°ì € í—¤ë” ì ìš©)
          TARGET_URL="https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do"
          PAGE_DATA=$(curl -s -k -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" "$TARGET_URL")

          # 2. í‚¤ì›Œë“œ ì„¤ì •
          KEYWORDS="ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€|ì´ˆê¸°ì°½ì—…íŒ¨í‚¤ì§€|ì°½ì—…ë„ì•½íŒ¨í‚¤ì§€|ì°½ì—…íŒ¨í‚¤ì§€|ì²­ë…„ì°½ì—…ì‚¬ê´€í•™êµ"

          # 3. ë°ì´í„° íŒŒì‹± (ì•„ì´í…œë³„ë¡œ ë¶„ë¦¬í•˜ì—¬ ì •í™•í•˜ê²Œ ë§¤ì¹­)
          # ê° ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ(li)ì„ ì¶”ì¶œí•˜ì—¬ ì œëª©, ë‚ ì§œ, ê³ ìœ ë²ˆí˜¸ë¥¼ íƒ­ìœ¼ë¡œ êµ¬ë¶„
          RAW_LIST=$(echo "$PAGE_DATA" | grep -zPo '(?s)<li class="item">.*?</li>' | tr -d '\n\r' | sed 's/<\/li>/\n/g' | \
          grep -E "$KEYWORDS" | \
          perl -lne 'print "$1\t$2\t$3" if /title="([^"]*)".*?<span>~ ([^<]*)<\/span>.*?pbancSn=(\d+)/')

          # 4. ë©”ì‹œì§€ ë¹Œë“œ (ë‚´ìš©ì´ ìˆì„ ë•Œë§Œ ë ˆì´ì•„ì›ƒ ìƒì„±)
          DATE=$(date +'%Y-%m-%d')
          
          if [ -z "$RAW_LIST" ]; then
            MESSAGE="ğŸ“… **$DATE ì•Œë¦¼**\ní˜„ì¬ ëª¨ì§‘ ì¤‘ì¸ ê´€ë ¨ í•µì‹¬ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤."
          else
            # ë©”ì‹œì§€ ìƒë‹¨ í—¤ë”
            MESSAGE="ğŸš€ **$DATE ë§ì¶¤í˜• ì°½ì—… ì§€ì› ê³µê³ **\n"
            MESSAGE="${MESSAGE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            
            # ë¦¬ìŠ¤íŠ¸ë¥¼ ëŒë©° ê°œë³„ í•­ëª© ì¶”ê°€
            while IFS=$'\t' read -r title dday sn; do
              if [[ ! -z "$title" ]]; then
                DETAIL_URL="https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do?schMnuId=S010101&pbancSn=$sn"
                MESSAGE="${MESSAGE}ğŸ“Œ **$title**\n"
                MESSAGE="${MESSAGE}ğŸ“… ë§ˆê°ì¼: \`$dday\`\n"
                MESSAGE="${MESSAGE}ğŸ”— [ìƒì„¸ê³µê³  ë°”ë¡œê°€ê¸°]($DETAIL_URL)\n\n"
              fi
            done <<< "$RAW_LIST"
          fi

          # 5. ë””ìŠ¤ì½”ë“œ ì „ì†¡ (jqë¥¼ ì‚¬ìš©í•˜ì—¬ JSON ì´ìŠ¤ì¼€ì´í”„ ë° \n ë¬¸ì ì˜¤ë¥˜ í•´ê²°)
          # printfë¥¼ ì‚¬ìš©í•˜ì—¬ ë³€ìˆ˜ ë‚´ì˜ ì¤„ë°”ê¿ˆì„ ì‹¤ì œ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì „ë‹¬
          PAYLOAD=$(printf '%s' "$MESSAGE" | jq -Rs '{content: .}')
          
          curl -X POST "$DISCORD_WEBHOOK" \
               -H "Content-Type: application/json" \
               -d "$PAYLOAD"
