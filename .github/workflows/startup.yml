name: K-Startup Daily Custom Alert

on:
  schedule:
    - cron: '0 0 * * *' # 한국 시간 오전 9시
  workflow_dispatch:

jobs:
  scan-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Scan K-Startup
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # 1. 데이터 가져오기
          URL="https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do"
          PAGE_DATA=$(curl -s -L -A "Mozilla/5.0" "$URL")

          # 2. 결과 메시지 초기화
          DATE=$(date +'%Y-%m-%d')
          FINAL_LIST=""

          # 3. 키워드 배열 설정
          KEYWORDS=("예비창업패키지" "초기창업패키지" "창업도약패키지" "창업패키지" "청년창업사관학교")

          # 4. 각 키워드별로 루프를 돌며 정보 추출
          for KW in "${KEYWORDS[@]}"; do
            # 해당 키워드가 포함된 공고 행(row)들을 찾아 제목과 마감일 추출 시도
            # K-Startup의 HTML 구조를 고려하여 제목(title)과 날짜 정보를 매칭
            EXTRACTED=$(echo "$PAGE_DATA" | grep -oP "title=\"[^\"]*$KW[^\"]*\"|<span>~ '2[0-9]\.[0-9][0-9]\.[0-9][0-9]\." | sed "s/title=\"//;s/\"//;s/<span>//")
            
            if [ ! -z "$EXTRACTED" ]; then
              # 제목과 날짜가 번갈아 가며 나올 수 있으므로 한 줄로 정리
              # 실무적으로 가장 매칭 확률이 높은 상위 공고 정리
              FORMATTED=$(echo "$EXTRACTED" | awk 'NR%2==1 {title=$0} NR%2==0 {print "📌 " title " / 📅 " $0 " / 🔗 [바로가기]('"$URL"')"}')
              FINAL_LIST="$FINAL_LIST$FORMATTED\n"
            fi
          done

          # 5. 디스코드 메시지 조립
          if [ -z "$FINAL_LIST" ]; then
            CONTENT="📅 **$DATE 알림**\n\n요청하신 키워드에 맞는 현재 모집 중인 공고가 없습니다."
          else
            CONTENT="🚀 **$DATE 맞춤형 창업 지원 공고**\n\n$FINAL_LIST"
          fi

          # 6. 전송
          jq -n --arg msg "$CONTENT" '{content: $msg}' | \
          curl -X POST "$DISCORD_WEBHOOK" -H "Content-Type: application/json" -d @-
