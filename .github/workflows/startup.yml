name: K-Startup Daily Custom Alert

on:
  schedule:
    - cron: '0 0 * * *' # í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:

jobs:
  scan-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Scan K-Startup
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (User-Agent í•„ìˆ˜)
          URL="https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do"
          PAGE_DATA=$(curl -s -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36" "$URL")

          # 2. í•µì‹¬ ì •ë³´ ì¶”ì¶œ ë° ì •ì œ
          # ì œëª©(title)ê³¼ ë‚ ì§œ(span) ì •ë³´ë¥¼ í•œ ì¤„ì”© ë²ˆê°ˆì•„ ë‚˜ì˜¤ê²Œ ì¶”ì¶œ
          EXTRACTED=$(echo "$PAGE_DATA" | grep -oP "title=\"[^\"]*(ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€|ì´ˆê¸°ì°½ì—…íŒ¨í‚¤ì§€|ì°½ì—…ë„ì•½íŒ¨í‚¤ì§€|ì°½ì—…íŒ¨í‚¤ì§€|ì²­ë…„ì°½ì—…ì‚¬ê´€í•™êµ)[^\"]*\"|<span>~ '[0-9]{2}\.[0-9]{2}\.[0-9]{2}\." | sed "s/title=\"//;s/\"//;s/<span>//")

          # 3. ë°ì´í„° í¬ë§·íŒ… (ì œëª© / ë§ˆê°ì¼ / ë§í¬)
          FINAL_LIST=""
          # ì½ì–´ì˜¨ ì¤„ì„ ë‘ ì¤„ì”© ì½ì–´ì„œ(ì œëª©, ë‚ ì§œ) í•œ ë¬¸ì¥ìœ¼ë¡œ í•©ì¹¨
          while read -r title; read -r date; do
            if [[ ! -z "$title" && ! -z "$date" ]]; then
              FINAL_LIST="${FINAL_LIST}ğŸ“Œ **$title**\nâ”” ğŸ“… ë§ˆê°ì¼: $date\nâ”” ğŸ”— [ê³µê³  ë°”ë¡œê°€ê¸°]($URL)\n\n"
            fi
          done <<< "$EXTRACTED"

          # 4. ë””ìŠ¤ì½”ë“œ ë©”ì‹œì§€ ì¡°ë¦½
          DATE=$(date +'%Y-%m-%d')
          if [ -z "$FINAL_LIST" ]; then
            CONTENT="ğŸ“… **$DATE ì•Œë¦¼**\n\ní˜„ì¬ ëª¨ì§‘ ì¤‘ì¸ ê´€ë ¨ í•µì‹¬ ê³µê³ (ì˜ˆë¹„Â·ì´ˆê¸°Â·ë„ì•½ íŒ¨í‚¤ì§€ ë“±)ê°€ ì—†ìŠµë‹ˆë‹¤."
          else
            CONTENT="ğŸš€ **$DATE ë§ì¶¤í˜• ì°½ì—… ì§€ì› ê³µê³ **\n\n$FINAL_LIST"
          fi

          # 5. ì „ì†¡ (jqë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ìˆ˜ë¬¸ì ì—ëŸ¬ ë°©ì§€)
          echo "$CONTENT" | jq -Rs '{content: .}' | \
          curl -X POST "$DISCORD_WEBHOOK" -H "Content-Type: application/json" -d @-
