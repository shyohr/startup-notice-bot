name: K-Startup Daily Morning Alert

on:
  schedule:
    # í•œêµ­ ì‹œê°„ ê¸°ì¤€ ë§¤ì¼ ì˜¤ì „ 9ì‹œ (UTC 00:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # í•„ìš”í•  ë•Œ ìˆ˜ë™ìœ¼ë¡œ ë²„íŠ¼ ëˆŒëŸ¬ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  scan-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Scan K-Startup and Send Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # 1. ê³µê³  í˜ì´ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (User-Agentë¥¼ ë„£ì–´ì•¼ ì°¨ë‹¨ë˜ì§€ ì•ŠìŒ)
          PAGE_DATA=$(curl -s -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36" \
            "https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do")

          # 2. í•µì‹¬ í‚¤ì›Œë“œ ì„¤ì • (ì‚¬ìš©ìë‹˜ ê´€ì‹¬ì‚¬ ë°˜ì˜)
          KEYWORDS="ì˜ˆë¹„|íŒ¨í‚¤ì§€|ì²­ë…„|ì‚¬ê´€í•™êµ|ë„ì•½|í¬ë§ë¦¬í„´|ê²½ì˜ê°œì„ "

          # 3. HTMLì—ì„œ ê³µê³  ì œëª© ë¶€ë¶„ë§Œ ì¶”ì¶œ (ì •ê·œì‹ í™œìš©)
          # title ì†ì„±ì— ë“¤ì–´ìˆëŠ” í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ì—¬ í‚¤ì›Œë“œ ë§¤ì¹­
          MATCHES=$(echo "$PAGE_DATA" | grep -oP 'title="[^"]*(?:'"$KEYWORDS"')[^"]*"' | sed 's/title="//;s/"//' | head -n 8)

          # 4. ë””ìŠ¤ì½”ë“œ ë©”ì‹œì§€ ì¡°ë¦½
          DATE=$(date +'%Y-%m-%d')
          
          if [ -z "$MATCHES" ]; then
            CONTENT="ğŸ“… **$DATE K-Startup ê³µê³  ìš”ì•½**\n\ní˜„ì¬ ì„¤ì •í•œ í‚¤ì›Œë“œ(`$KEYWORDS`)ì— ë§ëŠ” ìƒˆë¡œìš´ ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ í™•ì¸í•´ë³´ì„¸ìš”! ğŸ”"
          else
            # ëª©ë¡ì„ ë³´ê¸° ì¢‹ê²Œ ë¶ˆë › í¬ì¸íŠ¸ë¡œ ì •ë¦¬
            LIST_ITEMS=$(echo "$MATCHES" | sed 's/^/- /')
            CONTENT="ğŸ“¢ **$DATE í•µì‹¬ ì°½ì—…Â·ì˜ˆë¹„ì°½ì—… ê³µê³  ì•Œë¦¼**\n\ní˜„ì¬ ëª¨ì§‘ ì¤‘ì¸ ì£¼ìš” ì‚¬ì—…ì…ë‹ˆë‹¤:\n\n$LIST_ITEMS\n\nğŸ”— [K-Startup ë°”ë¡œê°€ê¸°](https://www.k-startup.go.kr/web/contents/bizpbanc-ongoing.do)"
          fi

          # 5. JSON í˜ì´ë¡œë“œ ìƒì„± ë° ë””ìŠ¤ì½”ë“œ ì „ì†¡
          jq -n --arg msg "$CONTENT" '{content: $msg}' | \
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d @-
